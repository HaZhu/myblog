<html>
<%- include('../public/user/head.ejs') %>

    <body class="sub-page">
        <%- include('../public/user/nav.ejs') %>

            <div class="site-gradients">
                <div class="site-gradients-media">
                    <figure>
                        <img src="user/leaves/images/backgroundLeaves.jpg" alt="">
                    </figure>
                </div>
            </div>
            <div id="page-content" class="single-page" style="position: relative;">
                <div id="container">
                    <div id="leafContainer"></div>
                </div>
                <div class="container">
                    <div class="row">
                        <div id="main-content" style="margin-top: 200px;">
                            <article>
                                <div class="art-content">
                                  <div id="crop-avatar">
                                   <div class="headImgBoxUpdata avatar-view" data-headImgID=''>
                                       <img src="" alt="">
                                   </div>
                                  </div> 
                                    <div class="backLoginBox">
                                        <a id="resPsw" href="javascript:;">修改密码</a>
                                        <a id="levaLogin" href="javascript:;">退出登录</a>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 box-item">
                                            <h3>个人信息<span class="edite glyphicon glyphicon-pencil" style="margin-left:15px;cursor: pointer"></span></h3>
                                            <p class="nickname">昵称：<em></em></p>
                                            <p class="phoneNunber">手机：<em></em></p>
                                            <p class="address">地址：<em></em></p>
                                            <p class="gender">性别：<em></em></p>
                                            <p class="marriage">婚姻：<em></em></p>
                                            <p class="studyInfo">学历：<em></em></p>
                                        </div>
                                        <div class="col-md-8">
                                            <h3>来一发吧！</h3>
                                            <form>
<!--
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <input type="text" class="form-control input-lg" name="name" id="msgName" placeholder="落款署名" required="required" style="color:#000" />
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <input type="tel" class="form-control input-lg" name="phone" id="msgPhone" placeholder="联系方式" required="required" style="color:#000" />
                                                        </div>
                                                    </div>
                                                </div>
-->
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <input type="text" class="form-control input-lg" name="title" id="msgTitle" placeholder="留言标题" required="required" style="color:#000" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row" style="margin:15px 0;position: relative;">
                                                    <!--                                                    <div class="inputButton"></div>-->
                                                    <div class="col-md-12" style="padding:0">
                                                        <div class="col-md-5" style="padding:0">
                                                            <button type="button" class="btn btn-primary" style="position: absolute;left: 0;top:-3px;z-index: 99">请选择一张背景图,不选系统随机配图</button>
                                                            <input type="file" id="exampleInputFile" style="opacity:0;z-index:999;position: relative">
                                                        </div>
                                                        <div class="col-md-7" style="padding:0"><img id="ImgPr" width="10" height="10" /></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <textarea maxlength="135" name="message" class="form-control" rows="5" cols="25" required="required" id="msgContent" placeholder="留言内容(不要超过135个字！)" style="height: 100px;color:#000"></textarea>
                                                        </div>
                                                        <button type="button" class="btn btn-skin btn-block" name="submitcontact" id="submitcontact">提交发布</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="avatar-modal" aria-hidden="true" aria-labelledby="avatar-modal-label" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg" style="margin-top:120px;">
            <div class="modal-content">
                <form class="avatar-form" action="/api_user_headImgUpdate" enctype="multipart/form-data" method="post">
                    <div class="modal-header">
                        <button class="close" data-dismiss="modal" type="button">&times;</button>
                        <h4 class="modal-title" id="avatar-modal-label">头像修改</h4>
                    </div>
                    <div class="modal-body">
                        <div class="avatar-body">
                            <div class="avatar-upload">
                                <input class="avatar-src" name="avatar_src" type="hidden">
                                <input class="avatar-data" name="avatar_data" type="hidden">
                                <input class="avatar-id" name="avatar_id" type="hidden">
                                <label for="avatarInput">图片上传</label>
                                <input class="avatar-input" id="avatarInput" name="avatar_file" type="file">
                            </div>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="avatar-wrapper"></div>
                                </div>
                                <div class="col-md-3">
                                    <div class="avatar-preview preview-lg"></div>
                                    <div class="avatar-preview preview-md"></div>
                                    <div class="avatar-preview preview-sm"></div>
                                </div>
                            </div>
                            <div class="row avatar-btns">
                                <div class="col-md-9">
                                    <div class="btn-group">
                                        <button class="btn" data-method="rotate" data-option="-90" type="button" title="Rotate -90 degrees" style="background:#5CB85C"><i class="fa fa-undo"></i> 向左旋转</button>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn" data-method="rotate" data-option="90" type="button" title="Rotate 90 degrees" style="background:#5CB85C"><i class="fa fa-repeat"></i> 向右旋转</button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success btn-block avatar-save" type="submit"><i class="fa fa-save"></i> 保存修改</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="loading" aria-label="Loading" role="img" tabindex="-1"></div>

            <%- include('../public/user/footer.ejs') %>
                <script src="user/js/imgView.js"></script>
                <script src="user/css/updataImg/cropper.min.js"></script>
                <script src="user/css/updataImg/sitelogo.js"></script>
                <script>
                    $('.maps').click(function () {
                        $('.maps iframe').css("pointer-events", "auto");
                    });

                    $(".maps").mouseleave(function () {
                        $('.maps iframe').css("pointer-events", "none");
                    });
                    $('.nav a').eq(5).addClass('active');
                    $(document).off('click', '#save').on('click', '#save', function () {
                        $.ajax({
                            type: 'post',
                            dataType: 'json',
                            url: '/api_user_Modify_info',
                            data: {
                                'oldNickname': $.trim(localStorage.userName),
                                'nickname': $.trim($("#nickname").val()),
                                'phoneNunber': $.trim($("#phoneNunber").val()),
                                'address': $.trim($("#address").val().trim()),
                                'oldphoneNunber': $.trim($(".phoneNunber em").text())
                            },
                            success: function (res) {
                                if (res.status == 1) {
                                    localStorage.userName = $("#nickname").val();
                                    layer.closeAll();
                                    layer.msg(res.data);
                                    setTimeout(function () {
                                        location.reload();
                                    }, 1000)
                                } else {
                                    layer.msg(res.data);
                                }
                            },
                            error: function (err) {
                                console.log(err)
                            }
                        })
                    })
                    $(document).off('click', '#saveNewPassword').on('click', '#saveNewPassword', function () {
                        $.ajax({
                            type: 'post',
                            dataType: 'json',
                            url: '/api_user_password',
                            data: {
                                'nickname': localStorage.userName,
                                'oldPassword': $.trim($("#oldpassword").val()),
                                'newPassword': $.trim($("#newpassword").val()),
                                'RePassword': $.trim($("#renewpassword").val())
                            },
                            success: function (res) {
                                if (res.status == 1) {
                                    layer.closeAll();
                                    layer.msg(res.data);
                                } else {
                                    layer.msg(res.data);
                                }
                            },
                            error: function (err) {
                                console.log(err)
                            }
                        })
                    })
                    $.ajax({
                        type: 'post',
                        dataType: 'json',
                        url: '/api_user_contact',
                        data: {
                            'nickname': localStorage.userName
                        },
                        success: function (res) {
                            if (res.status == 1) {
                                if (res.data[0].address == "") {
                                    res.data[0].address = "未填写！"
                                }
                                $(".nickname em").html(res.data[0].nickname);
                                $(".phoneNunber em").html(res.data[0].phoneNunber);
                                $(".address em").html(res.data[0].address);
                                $(".gender em").html(res.data[0].gender);
                                $(".marriage em").html(res.data[0].marriage);
                                $(".studyInfo em").html(res.data[0].studyInfo);
                                $(".headImgBoxUpdata img").attr('src',res.data[0].headImg);
                                $(".avatar-id").val(res.data[0].id);
                            } else {
                                localStorage.userName = "";
                                location.href = '/';

                            }
                        },
                        error: function (err) {
                            console.log(err)
                        }
                    })
                    $('.edite').on('click', function () {
                        var _html = '';
                        _html += '<div class="editBox" style="padding:30px">';
                        _html += '<form class="form-horizontal" role="form">';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputEmail3" class="col-sm-2 control-label pdTop15">昵称</label>';
                        _html += '<div class="col-sm-10">';
                        _html += '<input type="text" class="form-control" style="color:#000;font-size:16px;" maxlength="10" id="nickname" placeholder="' + $(".nickname em").html() + '" value="' + $(".nickname em").html() + '">';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputPassword3" class="col-sm-2 control-label pdTop15">手机</label>';
                        _html += '<div class="col-sm-10">';
                        _html += '<input type="text" class="form-control" style="color:#000;font-size:16px;" maxlength="11" id="phoneNunber" placeholder="' + $(".phoneNunber em").html() + '" value="' + $(".phoneNunber em").html() + '">';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputPassword3" class="col-sm-2 control-label pdTop15">地址</label>';
                        _html += '<div class="col-sm-10">';
                        _html += '<input type="text" class="form-control" style="color:#000;font-size:16px;" maxlength="16" id="address" placeholder="' + $(".address em").html() + '" value="' + $(".address em").html() + '">';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<div class="col-sm-offset-2 col-sm-10">';
                        _html += '<input type="button" id="save" class="btn btn-primary" value="保存">';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '</form>';
                        _html += '</div>';

                        layer.open({
                            title: '个人信息修改',
                            type: 1,
                            content: _html,
                            area: ['800px', '400px'],
                            offset: '100px'
                        });
                    });
                    $("#levaLogin").on('click', function () {
                        layer.confirm('确定退出登录？', {
                            btn: ['确定', '取消'] //可以无限个按钮
                        }, function () {
                            localStorage.userName = "";
                            localStorage.headImg = "user/images/public/head.png";
                            location.href = "/"
                        }, function () {
                            return;
                        });
                    });
                    $("#resPsw").on('click', function () {
                        var _html = '';
                        _html += '<div class="editBox" style="padding:30px">';
                        _html += '<form class="form-horizontal" role="form">';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputEmail3" class="col-sm-3 control-label pdTop15">请输入原密码</label>';
                        _html += '<div class="col-sm-9">';
                        _html += '<input type="password" class="form-control" maxlength="16" id="oldpassword" >';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputPassword3" class="col-sm-3 control-label pdTop15">请输入新密码</label>';
                        _html += '<div class="col-sm-9">';
                        _html += '<input type="password" class="form-control" maxlength="16" id="newpassword" >';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<label for="inputPassword3" class="col-sm-3 control-label pdTop15">请再次输入新密码</label>';
                        _html += '<div class="col-sm-9">';
                        _html += '<input type="password" class="form-control" maxlength="16" id="renewpassword" >';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '<div class="form-group">';
                        _html += '<div class="col-sm-offset-3 col-sm-9">';
                        _html += '<input type="button" id="saveNewPassword" class="btn btn-primary" value="保存">';
                        _html += '</div>';
                        _html += '</div>';
                        _html += '</form>';
                        _html += '</div>';
                        layer.open({
                            title: '密码修改',
                            type: 1,
                            content: _html,
                            area: ['800px', '400px'],
                            offset: '100px'
                        })
                    })
                    $("#exampleInputFile").uploadPreview({
                        Img: "ImgPr",
                        Width: 10,
                        Height: 10
                    });
                    //提交留言
                    $('#submitcontact').on('click', function () {
                        if($('#msgTitle').val().length<2){
                            layer.msg('标题不能小于2个字符',{icon:5});
                            return;
                        }
                        if($.trim($('#msgContent').val()).length<10){
                            layer.msg('内容不能小于10个字符',{icon:5});
                            return;
                        }
                        var _data = new FormData();
                        _data.append("mgsBcImg", $('#exampleInputFile')[0].files[0]);
                        _data.append("msgTitle", $.trim($('#msgTitle').val()));
                        _data.append("msgFrom", $.trim(localStorage.userName));
                        _data.append("msgUserNumber", $.trim($('.phoneNunber em').text()));
                        _data.append("msgContent", $.trim($('#msgContent').val()));
                        _data.append("headImgShow", $('.headImgBoxUpdata img').attr('src'));
                        $.ajax({
                            type: 'post',
                            dataType: 'json',
                            url: '/api_user_toMsg',
                            processData: false,
                            contentType: false,
                            data: _data,
                            success: function (res) {
                                $('#msgTitle').val('');
                                $('#msgContent').val('');
                                if (res.status == 1) {
                                    layer.msg('留言成功！去看看吧！',{icon:6})
                                }else{
                                    layer.msg(res.data,{icon:6})
                                }
                            }
                        })
                    })
                </script>
    </body>

</html>